<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[grpc源码分析-Functional Options Patter]]></title>
    <url>%2F2018%2F01%2F03%2Fgrpc-functional-options-patter%2F</url>
    <content type="text"><![CDATA[在开发中，经常会将一个方法的参数设置为可选，并设置一些默认值，使代码更通用简洁。在很多语言中这很容易，比如在C类语言中,可以使用相同方法名不同参数的多个版本(重写)， 而在像python这样的语言中, 可以给参数一个默认值，并在调用方法时忽略它们。但是在 Go中, 这两种方式都用不了。 像构造方法这是一个非常常见的用例，拿它来做例子。比方说,我们有一些名为Client的结构,它有一个连接和附属参数(timeout和retries)，然后我们提供一个构造方法。12345678910111213141516type Client interface &#123; Do() error&#125;type client struct &#123; conn Connection timeout int retries int&#125;func NewClient(conn Connection, timeout, retries int) Client &#123; return &amp;client&#123; conn: conn, timeout: timeout, retries: retries, &#125;&#125; 但是每次调用NewClient时都要提供timeout和retries。而大多数时候只想使用默认值。一个方法是创建另一个不同名称的构造方法。12func NewClient(conn Connection) Clientfunc NewClientWithOptions(conn Connection, timeout, retries int) Client 另一种是传入了一个配置对象。12345type Options struct &#123; Retries int Timeout int&#125;func NewClient(conn Connection, options Options) Client 不够优雅，要么要写非常多的构造方法，要么需要在代码中进行额外的检查和验证或通过传递不关心的参数来为做额外判断的工作。而grpc使用的是一种干净的解决方案: Functional Options Patter。123456789101112131415161718type dialOptions struct &#123; ... insecure bool timeout time.Duration ...&#125;type DialOption func(*dialOptions)type ClientConn struct &#123; ... dopts dialOptions ...&#125;func Dial(target string, opts ...DialOption) (*ClientConn, error) &#123; return DialContext(context.Background(), target, opts...)&#125; ClientConn主要附属参数在dopts中，构造方法Dial参数是可选个数的DialOption。是不是觉得和上面第二种没什么区别，注意传进去的DialOption是方法，先看看库里几个常见的方法的实现。1234567891011func WithInsecure() DialOption &#123; return func(o *dialOptions) &#123; o.insecure = true &#125;&#125;func WithTimeout(d time.Duration) DialOption &#123; return func(o *dialOptions) &#123; o.timeout = d &#125;&#125; dialOptions是可用选项，定义了一些方法WithInsecure和WithTimeout, 它们返回一个闭包函数，用来修改dialOptions的选项。 另外又定义了DialOption, 它是一个接受这些方法。接着我们来看构造方法的关键部分。12345678910111213141516func DialContext(ctx context.Context, target string, opts ...DialOption) (conn *ClientConn, err error) &#123; cc := &amp;ClientConn&#123; target: target, csMgr: &amp;connectivityStateManager&#123;&#125;, conns: make(map[*addrConn]struct&#123;&#125;), blockingpicker: newPickerWrapper(), &#125; ... // 如果想设置默认值可以 cc.dopts = DefaultDopts for _, opt := range opts &#123; opt(&amp;cc.dopts) &#125; ...&#125; 构造函数遍历了DialOption列表, 并对每一项应用返回的闭包运用到的选项dopts。使用起来也很方便。12grpc.Dial(addr, grpc.WithInsecure())grpc.Dial(addr, grpc.WithInsecure(), grpc.WithTimeout(time.Duration(10*time.Second))) 而且我们可以随时添加新的选项, 只需要对代码进行非常少量的更改。]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
        <tag>grpc</tag>
        <tag>源码分析</tag>
      </tags>
  </entry>
</search>
